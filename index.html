<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keystroke Recognition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body.light-theme {
            background-color: #ffffff;
            color: #000000;
        }
        body.dark-theme {
            background-color: #000000;
            color: #ffffff;
        }
        #processResults li, #streamResults li {
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
        }
    </style>
</head>
<body class="light-theme min-h-screen flex flex-col items-center justify-center p-4">
    <button id="themeToggle" class="fixed top-4 right-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700" onclick="toggleTheme()">
        <i id="themeIcon" class="fas fa-sun text-yellow-500"></i>
    </button>
    <h1 class="text-3xl font-bold mb-6">Keystroke Recognition System</h1>

    <div id="recordAudio" class="mb-6">
        <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="recordAudio()">Record Audio (5s)</button>
        <p id="recordStatus" class="mt-2"></p>
    </div>

    <div id="processAudio" class="mb-6">
        <input type="file" id="audioFile" accept="audio/*" class="mb-2">
        <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" onclick="processAudio()">Process Audio</button>
        <div id="processResults" class="mt-4"></div>
    </div>

    <div id="streamAudio" class="mb-6">
        <button class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded" onclick="startStreaming()">Start Streaming (30s)</button>
        <div id="streamResults" class="mt-4"></div>
    </div>

    <div id="trainModel" class="mb-6">
        <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" onclick="trainModel()">Train Model</button>
        <p id="trainStatus" class="mt-2"></p>
    </div>

    <script>
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            if (body.classList.contains('light-theme')) {
                body.classList.replace('light-theme', 'dark-theme');
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                themeIcon.classList.replace('text-yellow-500', 'text-gray-300');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.replace('dark-theme', 'light-theme');
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                themeIcon.classList.replace('text-gray-300', 'text-yellow-500');
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const body = document.body;
            const themeIcon = document.getElementById('themeToggle').querySelector('i');
            if (savedTheme === 'dark') {
                body.classList.replace('light-theme', 'dark-theme');
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                themeIcon.classList.replace('text-yellow-500', 'text-gray-300');
            }
        });

        async function recordAudio() {
            document.getElementById('recordStatus').innerText = 'Recording...';
            try {
                const response = await fetch('http://localhost:8000/record/?duration=5', { method: 'POST' });
                const result = await response.json();
                if (result.error) {
                    document.getElementById('recordStatus').innerText = `Error: ${result.error}`;
                } else {
                    document.getElementById('recordStatus').innerText = `Audio recorded: ${result.filename}`;
                }
            } catch (error) {
                console.error('Error recording audio:', error);
                document.getElementById('recordStatus').innerText = 'Error recording audio';
            }
        }

        async function processAudio() {
            const fileInput = document.getElementById('audioFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select an audio file');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch('http://localhost:8000/process/', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                displayResults(result, 'processResults');
            } catch (error) {
                console.error('Error processing audio:', error);
                document.getElementById('processResults').innerText = 'Error processing audio';
            }
        }

        async function startStreaming() {
            try {
                const response = await fetch('http://localhost:8000/stream/?duration=30', { method: 'POST' });
                const result = await response.json();
                displayResults(result, 'streamResults');
            } catch (error) {
                console.error('Error streaming audio:', error);
                document.getElementById('streamResults').innerText = 'Error streaming audio';
            }
        }

        async function trainModel() {
            document.getElementById('trainStatus').innerText = 'Training model...';
            try {
                const response = await fetch('http://localhost:8000/train/', { method: 'POST' });
                const result = await response.json();
                if (result.error) {
                    document.getElementById('trainStatus').innerText = `Error: ${result.error}`;
                } else {
                    document.getElementById('trainStatus').innerText = 'Model trained successfully';
                }
            } catch (error) {
                console.error('Error training model:', error);
                document.getElementById('trainStatus').innerText = 'Error training model';
            }
        }

        function displayResults(data, elementId) {
            const resultsDiv = document.getElementById(elementId);
            resultsDiv.innerHTML = '';
            if (data.error) {
                resultsDiv.innerText = `Error: ${data.error}`;
                return;
            }
            if (data.keystrokes && data.keystrokes.length > 0) {
                const ul = document.createElement('ul');
                data.keystrokes.forEach(ks => {
                    const li = document.createElement('li');
                    li.innerText = `Keystroke ${ks.keystroke}: ${ks.prediction} (Confidence: ${ks.confidence.toFixed(2)})`;
                    li.style.backgroundColor = ks.is_low_confidence ? 'yellow' : 'lightgreen';
                    ul.appendChild(li);
                });
                resultsDiv.appendChild(ul);
            }
            const summary = document.createElement('p');
            summary.innerText = `Summary: Characters: ${data.summary.characters}, Spaces: ${data.summary.spaces}, Enters: ${data.summary.enters}, Numbers: ${data.summary.numbers}`;
            resultsDiv.appendChild(summary);
        }
    </script>
</body>
</html>