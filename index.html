<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keystroke Recognition UI</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
 
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.24.7/babel.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Main App Component
    const App = () => {
      const [recording, setRecording] = useState(false);
      const [streaming, setStreaming] = useState(false);
      const [recordResult, setRecordResult] = useState(null);
      const [processResult, setProcessResult] = useState(null);
      const [streamResults, setStreamResults] = useState([]);
      const [trainResult, setTrainResult] = useState(null);
      const [error, setError] = useState(null);
      const [file, setFile] = useState(null);

      // Handle Record Audio
      const handleRecord = async () => {
        setRecording(true);
        setError(null);
        setRecordResult(null);
        try {
          const response = await fetch('http://localhost:8000/record/?duration=5', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          });
          const data = await response.json();
          if (response.ok) {
            setRecordResult(data);
          } else {
            setError(data.error || 'Recording failed');
          }
        } catch (err) {
          setError('Failed to connect to server');
        } finally {
          setRecording(false);
        }
      };

      // Handle File Upload and Process
      const handleFileUpload = async () => {
        if (!file) {
          setError('Please select a WAV file');
          return;
        }
        setError(null);
        setProcessResult(null);
        const formData = new FormData();
        formData.append('file', file);
        try {
          const response = await fetch('http://localhost:8000/process/', {
            method: 'POST',
            body: formData,
          });
          const data = await response.json();
          if (response.ok) {
            setProcessResult(data);
          } else {
            setError(data.error || 'Processing failed');
          }
        } catch (err) {
          setError('Failed to connect to server');
        }
      };

      // Handle Stream Audio
      const handleStream = async () => {
        if (streaming) {
          setStreaming(false);
          return;
        }
        setStreaming(true);
        setError(null);
        setStreamResults([]);
        try {
          const response = await fetch('http://localhost:8000/stream/?duration=30', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          });
          const data = await response.json();
          if (response.ok) {
            setStreamResults(data.keystrokes || []);
            if (data.summary) {
              setStreamResults((prev) => [
                ...prev,
                { summary: data.summary },
              ]);
            }
          } else {
            setError(data.error || 'Streaming failed');
          }
        } catch (err) {
          setError('Failed to connect to server');
        } finally {
          setStreaming(false);
        }
      };

      // Handle Train Model
      const handleTrain = async () => {
        setError(null);
        setTrainResult(null);
        try {
          const response = await fetch('http://localhost:8000/train/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          });
          const data = await response.json();
          if (response.ok) {
            setTrainResult(data);
          } else {
            setError(data.error || 'Training failed');
          }
        } catch (err) {
          setError('Failed to connect to server');
        }
      };

      // Render Keystroke Results
      const renderKeystrokes = (keystrokes) => {
        if (!keystrokes || keystrokes.length === 0) return null;
        return (
          <div className="mt-4">
            <h3 className="text-lg font-semibold">Keystrokes Detected:</h3>
            <ul className="mt-2 space-y-2 max-h-64 overflow-y-auto">
              {keystrokes.map((ks, index) => (
                ks.summary ? (
                  <li key={index} className="bg-gray-200 p-2 rounded">
                    <strong>Summary:</strong> {ks.summary.characters} chars, {ks.summary.spaces} spaces, {ks.summary.enters} enters, {ks.summary.numbers} numbers
                  </li>
                ) : (
                  <li key={index} className={`p-2 rounded ${ks.is_low_confidence ? 'bg-yellow-100' : 'bg-green-100'}`}>
                    Keystroke {ks.keystroke}: <strong>{ks.prediction}</strong> (Confidence: {(ks.confidence * 100).toFixed(2)}%)
                  </li>
                )
              ))}
            </ul>
          </div>
        );
      };

      // Render Summary
      const renderSummary = (summary) => {
        if (!summary) return null;
        return (
          <div className="mt-4 bg-blue-100 p-4 rounded">
            <h3 className="text-lg font-semibold">Summary:</h3>
            <p>Characters: {summary.characters}</p>
            <p>Spaces: {summary.spaces}</p>
            <p>Enters: {summary.enters}</p>
            <p>Numbers: {summary.numbers}</p>
          </div>
        );
      };

      return (
        <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
          <h1 className="text-2xl font-bold mb-4 text-center">Keystroke Recognition System</h1>
          
          {/* Error Message */}
          {error && (
            <div className="bg-red-100 text-red-700 p-3 rounded mb-4">
              {error}
            </div>
          )}

          {/* Record Audio */}
          <div className="mb-6">
            <h2 className="text-xl font-semibold mb-2">Record Audio</h2>
            <button
              onClick={handleRecord}
              disabled={recording}
              className={`w-full py-2 px-4 rounded text-white ${
                recording ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'
              }`}
            >
              {recording ? 'Recording...' : 'Record (5s)'}
            </button>
            {recordResult && (
              <div className="mt-2 bg-gray-100 p-2 rounded">
                Recorded file: {recordResult.filename}
              </div>
            )}
          </div>

          {/* Upload and Process Audio */}
          <div className="mb-6">
            <h2 className="text-xl font-semibold mb-2">Upload Audio</h2>
            <input
              type="file"
              accept=".wav"
              onChange={(e) => setFile(e.target.files[0])}
              className="mb-2 w-full"
            />
            <button
              onClick={handleFileUpload}
              disabled={!file}
              className={`w-full py-2 px-4 rounded text-white ${
                !file ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600'
              }`}
            >
              Process Audio
            </button>
            {processResult && (
              <div className="mt-4">
                {renderKeystrokes(processResult.keystrokes)}
                {renderSummary(processResult.summary)}
              </div>
            )}
          </div>

          {/* Stream Audio */}
          <div className="mb-6">
            <h2 className="text-xl font-semibold mb-2">Stream Audio</h2>
            <button
              onClick={handleStream}
              className={`w-full py-2 px-4 rounded text-white ${
                streaming ? 'bg-red-500 hover:bg-red-600' : 'bg-purple-500 hover:bg-purple-600'
              }`}
            >
              {streaming ? 'Stop Streaming' : 'Start Streaming (30s)'}
            </button>
            {renderKeystrokes(streamResults)}
          </div>

          {/* Train Model */}
          <div className="mb-6">
            <h2 className="text-xl font-semibold mb-2">Train Model</h2>
            <button
              onClick={handleTrain}
              className="w-full py-2 px-4 rounded bg-orange-500 hover:bg-orange-600 text-white"
            >
              Train Model
            </button>
            {trainResult && (
              <div className="mt-4 bg-gray-100 p-4 rounded">
                <p>{trainResult.message}</p>
                <p>Final Accuracy: {(trainResult.history?.accuracy?.slice(-1)[0] * 100 || 0).toFixed(2)}%</p>
                <p>Final Validation Accuracy: {(trainResult.history?.val_accuracy?.slice(-1)[0] * 100 || 0).toFixed(2)}%</p>
              </div>
            )}
          </div>

          <p className="text-center text-gray-600 mt-4">
            Built with React & Tailwind CSS for Cybersecurity Competition
          </p>
        </div>
      );
    };

    // Render App
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>